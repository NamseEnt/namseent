name: test-clippy-fmt
on:
  pull_request:

permissions:
  contents: write

concurrency:
  group: ${{ github.ref }}-test-clippy-fmt
  cancel-in-progress: true

env:
  CARGO_INCREMENTAL: 0
  RUSTFLAGS: -D warnings

defaults:
  run:
    shell: bash

jobs:
  wasm32-wasi-web:
    runs-on: macos-latest
    outputs:
      diff-artifact-id: ${{ steps.test-clippy-fmt-common.outputs.diff-artifact-id }}
    steps:
      - id: test-clippy-fmt-common
        uses: ./.github/actions/test-clippy-fmt-common.yml
        with:
          namui-target: wasm32-wasi-web
          rust-target: wasm32-wasip1-threads
          running-env: CLANGCC=${{ github.workspace }}/namui/namui-cli/wasi-sdk/bin/clang CLANGCXX=${{ github.workspace }}/namui/namui-cli/wasi-sdk/bin/clang++ CC=${{ github.workspace }}/namui/namui-cli/wasi-sdk/bin/clang CXX=${{ github.workspace }}/namui/namui-cli/wasi-sdk/bin/clang++ WASI_SDK=${{ github.workspace }}/namui/namui-cli/wasi-sdk WASI_SYSROOT=${{ github.workspace }}/namui/namui-cli/wasi-sdk/share/wasi-sysroot EMSDK_SYSTEM_INCLUDE=${{ github.workspace }}/namui/namui-cli/emscripten/system/include CLANG_PATH=${{ github.workspace }}/namui/namui-cli/wasi-sdk/bin/clang CARGO_TARGET_WASM32_WASIP1_THREADS_LINKER=${{ github.workspace }}/namui/namui-cli/wasi-sdk/bin/wasm-ld CARGO_BUILD_TARGET=wasm32-wasip1-threads

  aarch64-apple-darwin:
    runs-on: macos-latest
    outputs:
      diff-artifact-id: ${{ steps.test-clippy-fmt-common.outputs.diff-artifact-id }}
    steps:
      - id: test-clippy-fmt-common
        uses: ./.github/actions/test-clippy-fmt-common.yml
        with:
          namui-target: aarch64-apple-darwin
          rust-target: aarch64-apple-darwin

  x86_64-unknown-linux-gnu:
    runs-on: ubuntu-latest
    outputs:
      diff-artifact-id: ${{ steps.test-clippy-fmt-common.outputs.diff-artifact-id }}
    steps:
      - uses: awalsh128/cache-apt-pkgs-action@latest
        if: matrix.namui_target == 'x86_64-unknown-linux-gnu'
        with:
          packages: libasound2-dev libfontconfig-dev
      - id: test-clippy-fmt-common
        uses: ./.github/actions/test-clippy-fmt-common.yml
        with:
          namui-target: x86_64-unknown-linux-gnu
          rust-target: x86_64-unknown-linux-gnu

  x86_64-pc-windows-msvc:
    runs-on: windows-latest
    outputs:
      diff-artifact-id: ${{ steps.test-clippy-fmt-common.outputs.diff-artifact-id }}
    steps:
      - id: test-clippy-fmt-common
        uses: ./.github/actions/test-clippy-fmt-common.yml
        with:
          namui-target: x86_64-pc-windows-msvc
          rust-target: x86_64-pc-windows-msvc

  post-test-clippy-fmt:
    if: always()
    runs-on: ubuntu-latest
    needs:
      - wasm32-wasi-web
      - aarch64-apple-darwin
      - x86_64-unknown-linux-gnu
      - x86_64-pc-windows-msvc
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT_CARGO_LOCK_UPDATE }}

      - name: Download diffs
        uses: actions/download-artifact@v4
        with:
          artifact-ids: ${{ join(needs.*.outputs.diff-artifact-id, ',') }}
          path: ${{ runner.temp }}

      - name: Octopus merge changes and push
        run: |
          set -euo pipefail

          echo "=== Collecting patch files ==="
          patches=()
          for patch_file in ${{ runner.temp }}/**/*.patch; do
            if [[ -f "$patch_file" && -s "$patch_file" ]]; then
              target_name=$(basename "$patch_file" .patch)
              patches+=("$target_name:$patch_file")
              echo "Found non-empty patch: $target_name"
            elif [[ -f "$patch_file" ]]; then
              echo "Skipping empty patch: $(basename $patch_file)"
            fi
          done

          if [[ ${#patches[@]} -eq 0 ]]; then
            echo "No patches to apply. Exiting."
            exit 0
          fi

          echo "=== Setting up git config ==="
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          BASE_COMMIT=$(git rev-parse HEAD)
          ORIGINAL_BRANCH=$(git branch --show-current)
          echo "Base commit: $BASE_COMMIT"
          echo "Original branch: $ORIGINAL_BRANCH"

          echo "=== Creating feature branches and applying patches ==="
          branches=()

          for patch_info in "${patches[@]}"; do
            target_name="${patch_info%%:*}"
            patch_file="${patch_info##*:}"
            branch_name="auto-fix/$target_name"
            
            echo "Creating branch $branch_name and applying patch..."
            git checkout -b "$branch_name" "$BASE_COMMIT"
            
            if git apply "$patch_file" 2>/dev/null; then
              git add -A
              git commit -m "Auto-fix: Apply clippy and fmt changes for $target_name"
              branches+=("$branch_name")
              echo "✅ Successfully created $branch_name"
            else
              echo "❌ Failed to apply patch for $target_name"
              echo "Error details:"
              git apply "$patch_file" 2>&1 || true
              echo "::error::Patch $target_name cannot be applied cleanly"
              exit 1
            fi
          done

          git checkout "$ORIGINAL_BRANCH"

          echo "=== Performing octopus merge ==="
          echo "Merging branches: ${branches[*]}"

          if git merge --no-commit --no-ff "${branches[@]}"; then
            git commit -m "Auto-fix: Octopus merge clippy and fmt changes"
            git push origin HEAD
          else
            echo "❌ Octopus merge failed due to conflicts"
            git merge --abort || true
            exit 1
          fi
      - run: |
          echo ${{ join(needs.*.result, ',') }}
          any_test_failed=${{ contains(join(needs.*.result, ','), 'failure') }}
          echo $any_test_failed
          if [[ $any_test_failed == "true" ]]; then
              echo "::error::There are failed job"
              exit 1
          else
              echo "Good. No test failed"
          fi
